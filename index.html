<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆì¼ ì§€ì˜¤ë©”íŠ¸ë¦¬ ëŒ€ì‰¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: none; /* ëª¨ë°”ì¼ì—ì„œ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ */
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20; /* ì „ì²´í™”ë©´ ë²„íŠ¼ í´ë¦­ì„ ìœ„í•´ start-screen(10)ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
        }

        .hud-text {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 2px 2px 0 #000;
        }

        #score-box {
            top: 20px;
            left: 20px;
            text-align: left;
        }

        #hiscore-box {
            top: 20px;
            right: 20px;
            text-align: right;
            pointer-events: auto; /* ë²„íŠ¼ í´ë¦­ì„ ìœ„í•´ ì´ë²¤íŠ¸ í—ˆìš© */
        }

        #fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 5px;
            padding: 2px 8px;
            vertical-align: middle;
            font-family: 'Noto Sans KR', sans-serif;
            transition: background 0.2s;
        }

        #fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        #start-screen, #gameover-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 10;
        }

        h1 {
            color: #fff;
            font-size: 40px;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff00ff;
            line-height: 1.4;
        }

        .btn {
            padding: 15px 40px;
            font-size: 24px;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: bold;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #2E7D32;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #2E7D32;
        }

        .hidden {
            display: none !important;
        }

        .invincible-bar-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: none;
        }

        .invincible-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff8c00);
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        /* ë¬´ì  ëª¨ë“œ ì•Œë¦¼ í…ìŠ¤íŠ¸ */
        #mode-msg {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd700;
            font-size: 40px;
            font-weight: 900;
            text-shadow: 0 0 20px red;
            opacity: 0;
            transition: opacity 0.5s;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="score-box" class="hud-text">
            Lv. <span id="level-display">1</span><br>
            ì ìˆ˜: <span id="score-display">0</span>
        </div>
        <div id="hiscore-box" class="hud-text">
            Hi Score: <span id="hiscore-display">0</span>
            <button id="fullscreen-btn" title="ì „ì²´í™”ë©´">â›¶</button>
        </div>
        <div id="mode-msg">ë¬´ì  ëª¨ë“œ ë°œë™! ğŸ¤“</div>
        
        <div class="invincible-bar-container" id="invincible-ui">
            <div class="invincible-bar" id="invincible-bar"></div>
        </div>
    </div>

    <div id="start-screen">
        <h1>ìŠ¤ë§ˆì¼<br>ì§€ì˜¤ë©”íŠ¸ë¦¬ ëŒ€ì‰¬</h1>
        <p style="color: #ddd; margin-bottom: 30px; text-align: center; font-size: 18px;">
            Lv.2ë¶€í„° ì§€í˜•ì´ í—˜ë‚œí•´ì§‘ë‹ˆë‹¤! â›°ï¸<br>
            ë†’ì€ ê³„ë‹¨ì€ ë²½ì…ë‹ˆë‹¤. ë¶€ë”ªíˆë©´ ê²Œì„ ì˜¤ë²„! â˜ ï¸<br>
            2ë‹¨ ì í”„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤!<br>
            [ìŠ¤í˜ì´ìŠ¤ë°”] ë˜ëŠ” [í„°ì¹˜]ë¡œ ì í”„
        </p>
        <button class="btn" id="start-btn">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="gameover-screen" class="hidden">
        <h1>ê²Œì„ ì˜¤ë²„ ğŸ˜­</h1>
        <p style="color: #fff; font-size: 20px; margin-bottom: 20px;">
            ë‹¹ì‹ ì˜ ì ìˆ˜: <span id="final-score">0</span>
        </p>
        <button class="btn" id="restart-btn">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ (íš¨ê³¼ìŒ)
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'powerup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                osc.frequency.linearRampToValueAtTime(800, now + 0.2);
                osc.frequency.linearRampToValueAtTime(1500, now + 0.3);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'break') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.2);
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'gameover') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.linearRampToValueAtTime(300, now + 0.2);
                osc.frequency.linearRampToValueAtTime(100, now + 0.8);
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 1.0);
                osc.start(now);
                osc.stop(now + 1.0);
            }
        }

        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let isPlaying = false;
        let isCheatMode = false; // ì¹˜íŠ¸ ëª¨ë“œ í”Œë˜ê·¸
        let isSuperCheatMode = false; // Hí‚¤: ë²½ ìë™ ì í”„ í¬í•¨ ìŠˆí¼ ëª¨ë“œ
        let animationId;
        let frames = 0;
        let score = 0;
        
        // ìš”ì²­ ë°˜ì˜: í•˜ì´ìŠ¤ì½”ì–´ 0ìœ¼ë¡œ ì´ˆê¸°í™”
        localStorage.setItem('smileDashHiScore', 0);
        let highScore = 0;
        
        let level = 1;
        let gameSpeed = 10;
        let spawnTimer = 0;
        let lastTouchTime = 0; // í„°ì¹˜ ì¤‘ë³µ ë°©ì§€ ì‹œê°„ ë³€ìˆ˜
        
        // ì§€í˜• ê´€ë ¨ ë³€ìˆ˜
        let groundSegments = [];
        let baseGroundY; // ì´ˆê¸° ë°”ë‹¥ ë†’ì´
        let minGroundY;  // ì§€í˜• ìµœëŒ€ ë†’ì´ (ì²œì¥ì— ë‹¿ì§€ ì•Šê²Œ)
        let maxGroundY;  // ì§€í˜• ìµœì†Œ ë†’ì´ (ë°”ë‹¥ ì•„ë˜ë¡œ ì•ˆ êº¼ì§€ê²Œ)

        // ì „ì²´í™”ë©´ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            // ë²„íŠ¼ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ í•´ì œ (ìŠ¤í˜ì´ìŠ¤ë°” ì í”„ ì‹œ ë²„íŠ¼ ëˆŒë¦¼ ë°©ì§€)
            document.getElementById('fullscreen-btn').blur();

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });

        // í™”ë©´ í¬ê¸° ì„¤ì •
        function resizeCanvas() {
            const oldHeight = canvas.height; // ë³€ê²½ ì „ ë†’ì´ ì €ì¥
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // ê²Œì„ ë„ì¤‘(ì§€í˜• ìƒì„± í›„) í™”ë©´ í¬ê¸°ê°€ ë°”ë€Œë©´ ì˜¤ë¸Œì íŠ¸ë“¤ ìœ„ì¹˜ ë³´ì •
            if (oldHeight && groundSegments.length > 0) {
                const deltaY = canvas.height - oldHeight; // ë†’ì´ ë³€í™”ëŸ‰

                // í”Œë ˆì´ì–´ ìœ„ì¹˜ ë³´ì •
                player.y += deltaY;

                // ì§€í˜• ë³´ì •
                groundSegments.forEach(seg => {
                    seg.yStart += deltaY;
                    seg.yEnd += deltaY;
                });

                // ì¥ì• ë¬¼/ì•„ì´í…œ ë³´ì •
                gameObjects.forEach(obj => {
                    obj.y += deltaY;
                });
                
                // íŒŒí‹°í´ ë³´ì •
                particles.forEach(p => {
                    p.y += deltaY;
                });
            }

            // ë°”ë‹¥ì˜ í¬ê¸°(í™”ë©´ ì•„ë˜ë¶€í„°ì˜ ë†’ì´)ëŠ” 120ìœ¼ë¡œ ê³ ì •
            baseGroundY = canvas.height - 120;
            minGroundY = canvas.height * 0.4; // í™”ë©´ ìœ„ìª½ 40% ì§€ì ê¹Œì§€ë§Œ ì˜¬ë¼ê°
            maxGroundY = canvas.height - 50;  // í™”ë©´ ì•„ë˜ìª½ ì—¬ìœ 
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        document.getElementById('hiscore-display').innerText = highScore;

        const CHAR_NORMAL = 'ğŸ˜€';
        const CHAR_INVINCIBLE = 'ğŸ¤“';
        const CHAR_SUPER = 'ğŸ˜';
        const OBSTACLES = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'];
        const POWERUPS = ['ğŸŸ', 'ğŸ”', 'ğŸ•', 'ğŸ¥ª', 'ğŸŒ­'];

        // ë°°ê²½ ë³„ ìƒì„±
        class Star {
            constructor() {
                this.init();
            }
            init() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height * 0.8;
                this.size = Math.random() * 4 + 2; 
                this.speed = Math.random() * 2 + 0.5;
                this.alpha = Math.random();
            }
            update() {
                this.x -= this.speed;
                if (this.x < 0) {
                    this.x = canvas.width;
                    this.y = Math.random() * canvas.height * 0.8;
                }
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        const stars = [];
        for(let i=0; i<50; i++) {
            stars.push(new Star());
        }

        // --- ì§€í˜•(Ground) í´ë˜ìŠ¤ ë° ê´€ë¦¬ ---
        class GroundSegment {
            constructor(x, width, yStart, yEnd) {
                this.x = x;
                this.width = width;
                this.yStart = yStart;
                this.yEnd = yEnd;
            }

            update() {
                this.x -= gameSpeed;
            }

            draw() {
                ctx.fillStyle = '#2E7D32';
                ctx.beginPath();
                ctx.moveTo(this.x, this.yStart);
                ctx.lineTo(this.x + this.width, this.yEnd);
                ctx.lineTo(this.x + this.width, canvas.height);
                ctx.lineTo(this.x, canvas.height);
                ctx.closePath();
                ctx.fill();

                // ìƒë‹¨ ë¼ì¸ (ì”ë”” ëŠë‚Œ)
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(this.x, this.yStart);
                ctx.lineTo(this.x + this.width, this.yEnd);
                ctx.stroke();
            }

            // íŠ¹ì • x ìœ„ì¹˜ì—ì„œì˜ ì§€í˜• ë†’ì´ ë°˜í™˜
            getHeightAt(px) {
                if (px < this.x) return this.yStart;
                if (px > this.x + this.width) return this.yEnd;
                
                const ratio = (px - this.x) / this.width;
                return this.yStart + (this.yEnd - this.yStart) * ratio;
            }
        }

        function addGroundSegment() {
            let startX = 0;
            let startY = baseGroundY;

            if (groundSegments.length > 0) {
                const last = groundSegments[groundSegments.length - 1];
                startX = last.x + last.width;
                startY = last.yEnd;
            }

            // ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´
            const width = Math.random() * 300 + 400; // 400~700px ê¸¸ì´
            let endY = startY;

            // Lv.2 ë¶€í„° ì§€í˜• ë³€í™” ì‹œì‘ (ìš”ì²­ ë°˜ì˜)
            if (level >= 2) {
                const rand = Math.random();
                const delta = 100; // ë³€í™” í­
                
                // [ë‚œì´ë„ ì¡°ì •]: Lv.5 ì´ìƒì´ë©´ í‰ì§€ í™•ë¥  ëŒ€í­ ê°ì†Œ (40% -> 20%) (ìš”ì²­ ë°˜ì˜)
                const flatProbability = (level >= 5) ? 0.2 : 0.4;
                const slopeProbability = (level >= 5) ? 0.4 : 0.3; // ê²½ì‚¬ í™•ë¥  ì¦ê°€
                // ë‚˜ë¨¸ì§€ í™•ë¥ ì€ ê³„ë‹¨(ë‹¨ì°¨)

                if (rand < flatProbability) {
                    // í‰ì§€ ìœ ì§€
                    endY = startY;
                } else if (rand < flatProbability + slopeProbability) {
                    // ê²½ì‚¬ë¡œ (ì˜¤ë¥´ë§‰/ë‚´ë¦¬ë§‰)
                    if (startY < minGroundY + 100) endY = startY + delta;
                    else if (startY > maxGroundY - 100) endY = startY - delta;
                    else endY = startY + (Math.random() < 0.5 ? delta : -delta);
                } else {
                    // ê³„ë‹¨/ë‹¨ì°¨ (Step)
                    let stepHeight = (Math.random() < 0.5 ? -100 : 100);
                    
                    if (startY + stepHeight < minGroundY) stepHeight = 100;
                    if (startY + stepHeight > maxGroundY) stepHeight = -100;

                    startY += stepHeight; 
                    endY = startY; 
                }
            } else {
                // Lv 1: í‰ì§€ ìœ„ì£¼
                endY = baseGroundY;
                startY = (groundSegments.length > 0) ? groundSegments[groundSegments.length-1].yEnd : baseGroundY;
            }

            if (endY < minGroundY) endY = minGroundY;
            if (endY > maxGroundY) endY = maxGroundY;
            if (startY < minGroundY) startY = minGroundY;
            if (startY > maxGroundY) startY = maxGroundY;

            groundSegments.push(new GroundSegment(startX, width, startY, endY));
        }

        function updateGround() {
            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì§€í˜• ì œê±°
            if (groundSegments.length > 0 && groundSegments[0].x + groundSegments[0].width < -200) {
                groundSegments.shift();
            }

            // ìƒˆë¡œìš´ ì§€í˜• ìƒì„± (í™”ë©´ ì˜¤ë¥¸ìª½ ëë³´ë‹¤ ì—¬ìœ ìˆê²Œ)
            const lastSeg = groundSegments[groundSegments.length - 1];
            if (lastSeg.x + lastSeg.width < canvas.width + 500) {
                addGroundSegment();
            }

            groundSegments.forEach(seg => seg.update());
        }

        function getGroundYAt(x) {
            // í•´ë‹¹ xì¢Œí‘œì— ìˆëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            const seg = groundSegments.find(s => x >= s.x && x <= s.x + s.width);
            if (seg) return seg.getHeightAt(x);
            return canvas.height; // Fallback
        }


        // --- í”Œë ˆì´ì–´ ê°ì²´ ---
        const player = {
            x: 100,
            y: 0,
            baseWidth: 100, 
            baseHeight: 100,
            width: 100,
            height: 100,
            dy: 0,
            baseJumpPower: -23, 
            invincibleJumpPower: -34, 
            gravity: 1.2, 
            grounded: false,
            isInvincible: false,
            invincibleTimer: 0,
            invincibleMaxTime: 600,
            angle: 0,
            jumpCount: 0, // 2ë‹¨ ì í”„ë¥¼ ìœ„í•œ ì¹´ìš´íŠ¸
            
            draw() {
                ctx.save();
                
                // í¬ê¸°: ì¹˜íŠ¸ëª¨ë“œëŠ” ì»¤ì§€ì§€ ì•ŠìŒ, ì•„ì´í…œ ë¨¹ì—ˆì„ ë•Œë§Œ ì»¤ì§
                const isBig = this.isInvincible && !isCheatMode;
                const currentSize = isBig ? this.baseWidth * 1.5 : this.baseWidth;
                
                this.width = currentSize;
                this.height = currentSize;

                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                if (!this.grounded) {
                    this.angle += 0.15; 
                } else {
                    this.angle = 0;
                }
                
                // ì¡°ê±´: ì•„ì´í…œ ë¬´ì  ìƒíƒœì¼ ë•Œë§Œ íš¨ê³¼ ì ìš© (ì¹˜íŠ¸ ëª¨ë“œì—¬ë„ ì•„ì´í…œ ë¨¹ìœ¼ë©´ íš¨ê³¼ ë‚˜ì˜´)
                if (this.isInvincible && !isCheatMode) {
                    ctx.rotate(Math.sin(frames * 0.2) * 0.2); 
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 40 + Math.sin(frames * 0.1) * 20;
                } else {
                    // ì¼ë°˜ ìƒíƒœ í˜¹ì€ ì¹˜íŠ¸ ëª¨ë“œ ê¸°ë³¸ ìƒíƒœ
                    ctx.rotate(this.angle);
                    ctx.shadowBlur = 0;
                }

                ctx.font = `${this.width}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // ìºë¦­í„° ì´ëª¨ì§€: ìŠˆí¼ëª¨ë“œë©´ ğŸ˜, ì¼ë°˜ë¬´ì /ì¹˜íŠ¸ë©´ ğŸ¤“, í‰ì†Œ ğŸ˜€
                let char = CHAR_NORMAL;
                if (isSuperCheatMode) {
                    char = CHAR_SUPER;
                } else if (this.isInvincible || isCheatMode) {
                    char = CHAR_INVINCIBLE;
                }
                
                // [ìˆ˜ì •] yì¶• ì˜¤í”„ì…‹(this.width * 0.1) ì œê±°í•˜ì—¬ ì£¼ì¸ê³µì„ ì •ìœ„ì¹˜ì— ê·¸ë¦¼
                ctx.fillText(char, 0, 0); 
                ctx.restore();
            },

            update() {
                // í˜„ì¬ í”Œë ˆì´ì–´ ìœ„ì¹˜(ì¤‘ì•™)ì˜ ë°”ë‹¥ ë†’ì´ ê³„ì‚°
                const groundYUnderPlayer = getGroundYAt(this.x + this.width / 2);
                
                // ì¤‘ë ¥ ì ìš©
                this.y += this.dy;
                
                // ë°”ë‹¥ ì¶©ëŒ (ì°©ì§€)
                if (this.y + this.height >= groundYUnderPlayer) {
                    if (this.dy >= 0) {
                        this.dy = 0;
                        this.grounded = true;
                        this.jumpCount = 0; // ì°©ì§€ ì‹œ ì í”„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                        this.y = groundYUnderPlayer - this.height; // ë°”ë‹¥ ìœ„ì— ì•ˆì°©
                    }
                } else {
                    // [ìˆ˜ì •] ë‚´ë¦¬ë§‰ê¸¸ ë³´ì • (Slope Sticking)
                    // ì´ì „ì— ë°”ë‹¥ì— ìˆì—ˆê³ (grounded), ì í”„ ì¤‘ì´ ì•„ë‹ˆë©°(dy >= 0),
                    // ë°”ë‹¥ê³¼ì˜ ê±°ë¦¬ê°€ ê°€ê¹Œìš°ë©´(ë‚´ë¦¬ë§‰ê¸¸) ë–¨ì–´ì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë°”ë‹¥ì— ë¶™ì¸ë‹¤.
                    const distToGround = groundYUnderPlayer - (this.y + this.height);
                    const slopeThreshold = 30; // ë‚´ë¦¬ë§‰ê¸¸ í—ˆìš© ë²”ìœ„ (ê³„ë‹¨ì²˜ëŸ¼ í° ë‚™ì°¨ëŠ” ì œì™¸)

                    if (this.grounded && this.dy >= 0 && distToGround > 0 && distToGround <= slopeThreshold) {
                         this.y = groundYUnderPlayer - this.height;
                         this.dy = 0;
                         this.grounded = true;
                         this.jumpCount = 0;
                    } else {
                        this.dy += this.gravity;
                        this.grounded = false;
                    }
                }

                // [ìŠˆí¼ ëª¨ë“œ ìë™ ì í”„ ê°œì„ ] ë¶€ë”ªíˆê¸° ì „ì— ë¯¸ë¦¬ ê°ì§€í•˜ì—¬ ì í”„
                if (isSuperCheatMode && this.grounded) {
                    const lookAhead = 60; // 60px ì „ë°© ê°ì§€
                    const groundYAhead = getGroundYAt(this.x + this.width + lookAhead);
                    const wallThreshold = 30;
                    
                    // ì „ë°©ì— ë²½ì´ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì í”„
                    if (groundYAhead < this.y + this.height - wallThreshold) {
                        this.dy = this.baseJumpPower;
                        this.grounded = false;
                        playSound('jump');
                    }
                }

                // ì „ë°© ë²½ ì¶©ëŒ ì²´í¬ (ê¸°ì¡´ ì¶©ëŒ ë¡œì§)
                const groundYFront = getGroundYAt(this.x + this.width - 20); 
                const wallThreshold = 30; 
                if (groundYFront < this.y + this.height - wallThreshold) {
                    // [Hí‚¤ ê¸°ëŠ¥ êµ¬í˜„] ìŠˆí¼ ì¹˜íŠ¸ ëª¨ë“œì¼ ê²½ìš° ë²½ì„ ë§Œë‚˜ë©´ ìë™ ì í”„ (ì•ˆì „ì¥ì¹˜)
                    if (isSuperCheatMode) {
                        this.dy = this.baseJumpPower; // ê°•ì œ ì í”„
                        this.grounded = false;
                        playSound('jump'); // ì†Œë¦¬ë„ ì¬ìƒ
                    } else {
                        gameOver();
                    }
                }

                // íƒ€ì´ë¨¸ ë° ì…ì íš¨ê³¼
                if (this.isInvincible && !isCheatMode) {
                    this.invincibleTimer--;
                    updateInvincibleUI(this.invincibleTimer, this.invincibleMaxTime);
                    
                    if (frames % 4 === 0) {
                        createParticle(this.x + this.width/2, this.y + this.height/2, '#ffd700', 2);
                    }

                    if (this.invincibleTimer <= 0) {
                        this.isInvincible = false;
                        document.getElementById('mode-msg').style.opacity = '0';
                        document.getElementById('invincible-ui').style.display = 'none';
                        this.y += (this.width - this.baseWidth); 
                    }
                } 
            },

            jump() {
                // 2ë‹¨ ì í”„ í—ˆìš©: groundedì´ê±°ë‚˜ ì í”„ ì¹´ìš´íŠ¸ê°€ 2 ë¯¸ë§Œì¼ ë•Œ
                if (this.grounded || this.jumpCount < 2) {
                    playSound('jump');
                    const isSuperJump = this.isInvincible && !isCheatMode;
                    
                    // 2ë‹¨ ì í”„ ì‹œì—ëŠ” ì í”„ë ¥ì„ ì•½ê°„ ì¤„ì—¬ì£¼ëŠ” ê²ƒë„ ì¢‹ì§€ë§Œ, ì—¬ê¸°ì„  ë™ì¼í•˜ê²Œ ì ìš©
                    this.dy = isSuperJump ? this.invincibleJumpPower : this.baseJumpPower;
                    
                    this.grounded = false;
                    this.jumpCount++;
                }
            }
        };

        // ì¥ì• ë¬¼ ê´€ë¦¬
        let gameObjects = [];
        let particles = [];

        class GameObject {
            constructor(type, isFood) {
                this.x = canvas.width + 100; // í™”ë©´ ë°– ìƒì„±
                this.width = 100; 
                this.height = 100;
                
                const spawnGroundY = getGroundYAt(this.x);
                
                this.y = spawnGroundY - this.height; 
                this.isFood = isFood;
                this.markedForDeletion = false;
                
                if (isFood) {
                    this.emoji = POWERUPS[Math.floor(Math.random() * POWERUPS.length)];
                    this.y -= Math.random() * 70 + 180; 
                } else {
                    this.emoji = OBSTACLES[Math.floor(Math.random() * OBSTACLES.length)];
                }
            }

            update() {
                this.x -= gameSpeed;
                
                if (!this.isFood) {
                     const groundYHere = getGroundYAt(this.x + this.width/2);
                     this.y = groundYHere - this.height;
                }

                if (this.x + this.width < -100) this.markedForDeletion = true;
            }

            draw() {
                ctx.font = `${this.width}px sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(this.emoji, this.x, this.y);
            }
        }

        class Particle {
            constructor(x, y, color, sizeMultiplier = 1) {
                this.x = x;
                this.y = y;
                this.size = (Math.random() * 5 + 5) * sizeMultiplier;
                this.speedX = Math.random() * 10 - 5;
                this.speedY = Math.random() * 10 - 5;
                this.color = color;
                this.life = 40;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += 0.5; 
                this.life--;
            }
            draw() {
                ctx.globalAlpha = this.life / 40;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        function createParticle(x, y, color, count = 1) {
            for(let i=0; i<count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function spawnObject() {
            spawnTimer--;
            if (spawnTimer <= 0) {
                const isFood = Math.random() < 0.1; 
                gameObjects.push(new GameObject(null, isFood));
                
                let minGap = 100 - (level - 1) * (70 / 9); 
                let maxGap = 200 - (level - 1) * (160 / 9); 

                minGap = Math.max(30, minGap);
                maxGap = Math.max(minGap + 10, maxGap);
                
                spawnTimer = Math.floor(Math.random() * (maxGap - minGap) + minGap);
            }
        }

        function updateInvincibleUI(current, max) {
            const bar = document.getElementById('invincible-bar');
            const pct = (current / max) * 100;
            bar.style.width = `${pct}%`;
        }

        function checkCollisions() {
            gameObjects.forEach(obj => {
                const hitX = obj.x + 20;
                const hitY = obj.y + 20;
                const hitW = obj.width - 40;
                const hitH = obj.height - 20;

                const pX = player.x + 20;
                const pY = player.y + 20;
                const pW = player.width - 40;
                const pH = player.height - 20;

                if (
                    pX < hitX + hitW &&
                    pX + pW > hitX &&
                    pY < hitY + hitH &&
                    pY + pH > hitY
                ) {
                    if (obj.isFood) {
                        playSound('powerup');
                        obj.markedForDeletion = true;
                        activateInvincible();
                        score += 100;
                        createExplosion(obj.x + 50, obj.y + 50, '#00ff00', 20);
                    } else {
                        if (player.isInvincible || isCheatMode) {
                            playSound('break');
                            obj.markedForDeletion = true;
                            score += 50;
                            createExplosion(obj.x + 50, obj.y + 50, '#ff0000', 15);
                            canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
                            setTimeout(() => canvas.style.transform = 'none', 50);
                        } else {
                            gameOver();
                        }
                    }
                }
            });
        }

        function activateInvincible() {
            if (isCheatMode) return; 

            player.isInvincible = true;
            player.invincibleTimer = player.invincibleMaxTime;
            document.getElementById('mode-msg').style.opacity = '1';
            document.getElementById('invincible-ui').style.display = 'block';
        }

        function createExplosion(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                createParticle(x, y, color);
            }
        }

        function updateLevel() {
            // ì œí•œ ì—†ì´ ë ˆë²¨ ì¦ê°€ (ìš”ì²­ ë°˜ì˜)
            const newLevel = Math.floor(score / 1000) + 1; 
            if (newLevel > level) {
                level = newLevel;
                // ì†ë„ ì¦ê°€ (ë¬´í•œíˆ ë¹¨ë¼ì§€ë©´ ì¶©ëŒ ë²„ê·¸ê°€ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœëŒ€ 40ìœ¼ë¡œ ì•ˆì „ì¥ì¹˜ ì„¤ì •)
                gameSpeed = Math.min(40, 10 + (level - 1) * 2.0);
            }
            document.getElementById('level-display').innerText = level;
        }

        function drawBackground() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                star.update();
                star.draw();
            });
            
            groundSegments.forEach(seg => seg.draw());
        }

        function update() {
            if (!isPlaying) return;

            frames++;
            score++;
            document.getElementById('score-display').innerText = score;
            updateLevel();

            updateGround();

            player.update();

            spawnObject();
            gameObjects.forEach(obj => obj.update());
            gameObjects = gameObjects.filter(obj => !obj.markedForDeletion);

            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);

            checkCollisions();
        }

        function draw() {
            drawBackground();

            gameObjects.forEach(obj => obj.draw());
            player.draw();
            particles.forEach(p => p.draw());

            if (isPlaying) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }

        function gameLoop() {
            update();
            draw();
        }

        function initGame() {
            score = 0;
            level = 1;
            gameSpeed = 10; 
            frames = 0;
            spawnTimer = 60;
            gameObjects = [];
            particles = [];
            
            groundSegments = [];
            groundSegments.push(new GroundSegment(-100, canvas.width + 500, baseGroundY, baseGroundY));

            player.y = baseGroundY - player.height;
            player.dy = 0;
            player.isInvincible = false;
            player.invincibleTimer = 0;
            player.width = player.baseWidth; 
            player.height = player.baseHeight;
            player.jumpCount = 0;
            
            document.getElementById('mode-msg').style.opacity = '0';
            document.getElementById('invincible-ui').style.display = 'none';

            if (isSuperCheatMode) {
                 // ë©”ì‹œì§€ ìˆ¨ê¹€ ì²˜ë¦¬
                 document.getElementById('mode-msg').style.opacity = '0';
            } else if (isCheatMode) {
                 document.getElementById('mode-msg').style.opacity = '0';
            } else {
                 document.getElementById('mode-msg').innerText = "ë¬´ì  ëª¨ë“œ ë°œë™! ğŸ¤“";
            }
        }

        function startGame() {
            initAudio(); 
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('gameover-screen').classList.add('hidden');
            isPlaying = true;
            initGame();
            gameLoop();
        }

        function gameOver() {
            playSound('gameover');
            isPlaying = false;
            cancelAnimationFrame(animationId);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('smileDashHiScore', highScore);
                document.getElementById('hiscore-display').innerText = highScore;
            }

            document.getElementById('final-score').innerText = score;
            document.getElementById('gameover-screen').classList.remove('hidden');
        }

        function handleInput(e) {
            // ìŠ¤í˜ì´ìŠ¤ë°” ê¸°ë³¸ ë™ì‘(ìŠ¤í¬ë¡¤, ë²„íŠ¼ í´ë¦­ ë“±) ë°©ì§€
            if (e.code === 'Space') {
                e.preventDefault();
            }

            // ê³ ìŠ¤íŠ¸ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë°©ì§€: í„°ì¹˜ ì§í›„ì— ë°œìƒí•˜ëŠ” mousedown ì´ë²¤íŠ¸ ë¬´ì‹œ
            if (e.type === 'touchstart') {
                lastTouchTime = Date.now();
            } else if (e.type === 'mousedown') {
                // 500ms ë‚´ì— í„°ì¹˜ ì´ë²¤íŠ¸ê°€ ìˆì—ˆë‹¤ë©´ ë¬´ì‹œ
                if (Date.now() - lastTouchTime < 500) {
                    return;
                }
            }

            if ((e.code === 'Space' || e.type === 'touchstart' || e.type === 'mousedown') && isPlaying) {
                player.jump();
            }
            
            // ìŠˆí¼ ë¬´ì  ëª¨ë“œ ì¤‘ Jí‚¤ ëˆ„ë¥´ë©´ ê²Œì„ ì¢…ë£Œ
            // [ìˆ˜ì •] í•œê¸€ ì…ë ¥ ìƒíƒœì—ì„œë„ ì‘ë™í•˜ë„ë¡ e.key ëŒ€ì‹  e.code ì‚¬ìš©
            if (isPlaying && isSuperCheatMode && e.code === 'KeyJ') {
                gameOver();
            }

            if (!isPlaying && document.getElementById('gameover-screen').classList.contains('hidden')) {
                // [ìˆ˜ì •] í•œê¸€ ì…ë ¥ ìƒíƒœ í˜¸í™˜ì„ ìœ„í•´ e.code ì‚¬ìš©
                if (e.code === 'KeyZ') {
                    isCheatMode = true; 
                    isSuperCheatMode = false;
                    startGame();
                } else if (e.code === 'KeyH') { 
                    isCheatMode = true; 
                    isSuperCheatMode = true;
                    startGame();
                }
            }
        }

        window.addEventListener('keydown', handleInput);
        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput, {passive: false});

        document.getElementById('start-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            isCheatMode = false; 
            isSuperCheatMode = false;
            startGame();
        });

        document.getElementById('restart-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            isCheatMode = false; 
            isSuperCheatMode = false;
            startGame();
        });

        resizeCanvas();
        initGame(); 
        drawBackground();
        player.draw();

    </script>
</body>
</html>